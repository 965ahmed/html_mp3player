<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IndexedDB MP3 Player</title>
  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      background-color: #121212; /* Dark background */
      color: white; /* Default text color */
      overflow: hidden; /* Prevent scrolling */
    }
    h1 {
      text-align: center;
      margin: 10px 0;
      font-size: 2em; /* Larger title */
    }
    #fileLoader {
      margin: 10px auto;
      display: block;
      font-size: 1.5em; /* Larger file input */
      padding: 10px;
      border-radius: 8px;
      background-color: #333; /* Darker background for input */
      color: white; /* White text */
      cursor: pointer;
    }
    #main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 2fr; /* Four columns: A, B, C, and controls */
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
      height: calc(100vh - 60px); /* Leave room for header and fileLoader */
    }

    /* Button Groups */
    .button-group {
      display: grid;
      grid-template-rows: repeat(10, 1fr); /* 10 rows per column */
      gap: 10px;
    }

    /* Buttons */
    .button-group button {
      width: 100%;
      height: 100%;
      font-size: 2.5em; /* Larger text */
      padding: 0; /* Remove padding to maximize content space */
      border: none;
      border-radius: 8px;
      color: white; /* White text */
      background-color: transparent; /* Transparent background */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center; /* Center horizontally */
      align-items: center; /* Center vertically */
      text-align: center; /* Ensure text is centered */
    }

    /* Group Colors (Dark Shades) */
    .group-a { background-color: #2e7d32; } /* Dark Green */
    .group-b { background-color: #1565c0; } /* Dark Blue */
    .group-c { background-color: #d84315; } /* Dark Orange */
    .disabled {
      background-color: #444 !important; /* Dark gray for disabled buttons */
      color: #888 !important; /* Light gray text for disabled buttons */
    }

    /* Right Sidebar Controls */
    .right-controls {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
    }
    .right-controls button {
      height: 33%;
      font-size: 2em; /* Larger text for control buttons */
      border: none;
      border-radius: 8px;
      padding: 0; /* Remove padding to maximize content space */
      color: white; /* White text */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center; /* Center horizontally */
      align-items: center; /* Center vertically */
    }

    /* Colors for Sidebar Buttons */
    #playAll { background-color: #4527a0; } /* Dark Purple */
    #forward { background-color: #00695c; } /* Dark Teal */
    #backward { background-color: #ad1457; } /* Dark Pink */
  </style>
</head>
<body>
  <h1>IndexedDB MP3 Player</h1>
  <input type="file" id="fileLoader" accept="audio/mp3" multiple />
  <div id="main">
    <!-- Column for Group A buttons -->
    <div class="button-group" id="groupA"></div>
    <!-- Column for Group B buttons -->
    <div class="button-group" id="groupB"></div>
    <!-- Column for Group C buttons -->
    <div class="button-group" id="groupC"></div>
    <!-- Right sidebar controls -->
    <div class="right-controls">
      <button id="playAll">Play All</button>
      <button id="forward">Forward</button>
      <button id="backward">Backward</button>
    </div>
  </div>

  <script>
    const fileLoader = document.getElementById('fileLoader');
    const groupA = document.getElementById('groupA');
    const groupB = document.getElementById('groupB');
    const groupC = document.getElementById('groupC');
    const playAllBtn = document.getElementById('playAll');
    const forwardBtn = document.getElementById('forward');
    const backwardBtn = document.getElementById('backward');

    // An array for 30 audio objects (indices 0 to 29)
    const audios = Array(30).fill(null);
    // Retrieve enabled/disabled states from localStorage
    const enabled = JSON.parse(localStorage.getItem('mp3_enabled')) || Array(30).fill(true);
    let currentAudio = null;
    let currentIndex = 0;
    let stopFlag = false;

    /************ IndexedDB Setup ************/
    let db;
    const request = indexedDB.open('AudioDB', 1);

    request.onerror = () => alert('IndexedDB error');
    request.onsuccess = () => {
      db = request.result;
      loadStoredAudios();
    };
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      db.createObjectStore('audios', { keyPath: 'index' });
    };

    function saveToIndexedDB(index, file) {
      const reader = new FileReader();
      reader.onload = () => {
        const transaction = db.transaction(['audios'], 'readwrite');
        const store = transaction.objectStore('audios');
        store.put({ index, name: file.name, blob: reader.result });
      };
      reader.readAsArrayBuffer(file);
    }

    function loadStoredAudios() {
      const transaction = db.transaction(['audios'], 'readonly');
      const store = transaction.objectStore('audios');
      const req = store.getAll();

      req.onsuccess = () => {
        req.result.forEach(data => {
          const blob = new Blob([data.blob], { type: 'audio/mp3' });
          audios[data.index] = new Audio(URL.createObjectURL(blob));
        });
        if (req.result.length > 0) {
          alert('Restored ' + req.result.length + ' file(s) from storage.');
        }
      };
    }

    // File input onchange handler
    fileLoader.onchange = (e) => {
      const files = Array.from(e.target.files);
      files.forEach((file, i) => {
        const index = i;
        audios[index] = new Audio(URL.createObjectURL(file));
        saveToIndexedDB(index, file);
      });
      alert('Loaded and saved ' + files.length + ' file(s).');
    };

    // Create buttons
    function createButtons() {
      const groups = ['A', 'B', 'C'];
      const groupContainers = [groupA, groupB, groupC];

      for (let i = 0; i < 10; i++) {
        groups.forEach((prefix, col) => {
          const index = i + col * 10;
          const btn = document.createElement('button');
          btn.textContent = `${prefix}${i + 1}`; // Button text without icon
          btn.dataset.index = index;
          if (prefix === 'A') btn.classList.add('group-a');
          if (prefix === 'B') btn.classList.add('group-b');
          if (prefix === 'C') btn.classList.add('group-c');
          if (!enabled[index]) btn.classList.add('disabled');
          btn.onclick = () => toggleButton(btn, index);
          groupContainers[col].appendChild(btn);
        });
      }
    }

    // Toggle button state
    function toggleButton(btn, index) {
      enabled[index] = !enabled[index];
      localStorage.setItem('mp3_enabled', JSON.stringify(enabled));
      btn.classList.toggle('disabled', !enabled[index]);
    }

    // Play audio
    function playAudio(audio) {
      return new Promise((resolve) => {
        audio.currentTime = 0;
        audio.play();
        audio.onended = resolve;
        audio.onpause = resolve;
      });
    }

    // Play All button
    async function playAll() {
      if (playAllBtn.classList.contains('stopping')) {
        stopFlag = true;
        if (currentAudio) currentAudio.pause();
        playAllBtn.textContent = 'Play All';
        playAllBtn.classList.remove('stopping');
        return;
      }
      stopFlag = false;
      playAllBtn.textContent = 'Stop';
      playAllBtn.classList.add('stopping');

      for (let i = 0; i < audios.length; i++) {
        currentIndex = i;
        if (stopFlag) break;
        if (enabled[i] && audios[i]) {
          if (currentAudio) currentAudio.pause();
          currentAudio = audios[i];
          await playAudio(currentAudio);
        }
      }
      playAllBtn.textContent = 'Play All';
      playAllBtn.classList.remove('stopping');
    }

    // Forward button
    forwardBtn.onclick = () => {
      if (currentAudio) currentAudio.pause();
      for (let i = currentIndex + 1; i < audios.length; i++) {
        if (enabled[i] && audios[i]) {
          audios[i].currentTime = 0;
          audios[i].play();
          currentAudio = audios[i];
          currentIndex = i;
          break;
        }
      }
    };

    // Backward button
    backwardBtn.onclick = () => {
      if (currentAudio) currentAudio.pause();
      for (let i = currentIndex - 1; i >= 0; i--) {
        if (enabled[i] && audios[i]) {
          audios[i].currentTime = 0;
          audios[i].play();
          currentAudio = audios[i];
          currentIndex = i;
          break;
        }
      }
    };

    playAllBtn.onclick = playAll;

    // Prevent double-click zooming
    document.addEventListener('dblclick', (e) => {
      e.preventDefault();
    });

    // Finally, create the grid buttons.
    createButtons();
  </script>
</body>
</html>